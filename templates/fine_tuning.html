{% extends "base.html" %}

{% block page_title %}Fine Tuning{% endblock %}
{% block page_subtitle %}Advanced photo restoration with DeOldify colorization{% endblock %}

{% block extra_styles %}
<style>
    .upload-area {
        border: 3px dashed #667eea;
        border-radius: 8px;
        padding: 50px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9ff;
    }

    .upload-area:hover {
        border-color: #764ba2;
        background: #f0f2ff;
    }

    .upload-area.drag-over {
        border-color: #764ba2;
        background: #e8ebff;
        transform: scale(1.02);
    }

    .upload-icon {
        font-size: 3.5rem;
        margin-bottom: 15px;
    }

    .upload-text {
        font-size: 1.1rem;
        color: #333;
        margin-bottom: 8px;
    }

    .upload-hint {
        color: #666;
        font-size: 0.85rem;
    }

    input[type="file"] {
        display: none;
    }

    .hidden {
        display: none;
    }

    /* Processing Options */
    .options-card {
        background: #f8f9ff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .options-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
    }

    .option-group {
        margin-bottom: 15px;
    }

    .option-group label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: 500;
        color: #555;
    }

    .option-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        cursor: pointer;
    }

    .option-description {
        margin-left: 30px;
        font-size: 0.85rem;
        color: #888;
        margin-top: 4px;
    }

    /* Preview */
    .preview-container {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .preview-container.two-col {
        grid-template-columns: 1fr 1fr;
    }

    .preview-panel {
        text-align: center;
    }

    .preview-panel h3 {
        margin-bottom: 12px;
        color: #667eea;
        font-size: 1.1rem;
    }

    .preview-panel.mask h3 {
        color: #e53935;
    }

    .preview-panel img {
        max-width: 100%;
        max-height: 500px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .preview-panel.mask img {
        background: #000;
    }

    .preview-placeholder {
        background: #f0f0f0;
        border-radius: 8px;
        padding: 100px 20px;
        color: #999;
        font-size: 1rem;
    }

    .mask-info {
        font-size: 0.85rem;
        color: #666;
        margin-top: 8px;
    }

    /* Processing Status */
    .processing-status {
        background: #fff3cd;
        color: #856404;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
        text-align: center;
    }

    .processing-status.active {
        display: block;
    }

    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #856404;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
        vertical-align: middle;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Actions */
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
    }

    /* Info Box */
    .info-box {
        background: #e7f3ff;
        border-left: 4px solid #2196F3;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .info-box h4 {
        margin-bottom: 8px;
        color: #1976D2;
    }

    .info-box p {
        color: #555;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .feature-badge {
        display: inline-block;
        background: #ff9800;
        color: white;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 10px;
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block content %}
<div class="info-box">
    <h4>About Fine Tuning <span class="feature-badge">BETA</span></h4>
    <p>
        This feature uses advanced AI models for photo restoration. DeOldify specializes in colorizing
        black and white photos and restoring old photographs. Processing may take longer than batch enhancement
        as it uses deep learning models.
    </p>
</div>

<!-- Upload Section -->
<div class="card" id="uploadSection">
    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">ðŸŽ¨</div>
        <div class="upload-text">Click to select a photo or drag & drop here</div>
        <div class="upload-hint">Support: JPG, PNG | Single photo for advanced restoration</div>
    </div>
    <input type="file" id="fileInput" accept="image/*">
    <div class="error-message" id="errorMessage"></div>
</div>

<!-- Processing Section -->
<div class="card hidden" id="processingSection">
    <div class="options-card">
        <div class="options-title">Restoration Options</div>

        <div class="option-group">
            <label>
                <input type="checkbox" id="deoldifyOption" checked>
                DeOldify Colorization
            </label>
            <div class="option-description">
                Automatically colorize black and white photos using AI
            </div>
        </div>

        <div class="option-group">
            <label>
                <input type="checkbox" id="aiRestorationOption">
                AI Restoration (GFPGAN + Real-ESRGAN)
            </label>
            <div class="option-description">
                Deep learning enhancement for faces and image quality. <strong>Warning: Very slow, can take several minutes for large images.</strong>
            </div>
        </div>

        <div class="option-group">
            <label>
                <input type="checkbox" id="enhanceOption" checked>
                Standard Enhancement
            </label>
            <div class="option-description">
                Apply contrast, denoising, and sharpening improvements
            </div>
        </div>

        <div class="option-group">
            <label>
                <input type="checkbox" id="noiseReductionOption" checked>
                Noise Reduction
            </label>
            <div class="option-description">
                Remove grain and bright spots from old photos (stronger denoising)
            </div>
        </div>
    </div>

    <div class="preview-container two-col" id="previewContainer">
        <div class="preview-panel">
            <h3>Original Photo</h3>
            <img id="originalPreview" src="" alt="Original">
        </div>
        <div class="preview-panel mask hidden" id="maskPanel">
            <h3>Detection Mask</h3>
            <div class="preview-placeholder" id="maskPlaceholder">
                Mask will appear here after processing
            </div>
            <img id="maskPreview" src="" alt="Mask" class="hidden">
            <div class="mask-info">Red areas show detected artifacts that will be removed</div>
        </div>
        <div class="preview-panel">
            <h3>Restored Photo</h3>
            <div class="preview-placeholder" id="resultPlaceholder">
                Result will appear here after processing
            </div>
            <img id="resultPreview" src="" alt="Result" class="hidden">
        </div>
    </div>

    <div class="processing-status" id="processingStatus">
        <span class="spinner"></span>
        Processing your photo with AI... This may take a moment.
    </div>

    <div class="action-buttons">
        <button class="btn" id="processBtn" onclick="processPhoto()">
            Process Photo
        </button>
        <button class="btn btn-secondary" onclick="resetUpload()">
            Upload Different Photo
        </button>
        <button class="btn hidden" id="downloadBtn" onclick="downloadResult()">
            Download Result
        </button>
    </div>

    <div class="error-message" id="processError"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentFile = null;
    let resultFilename = null;

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    function handleFile(file) {
        if (!file.type.startsWith('image/')) {
            showError('Please select a valid image file');
            return;
        }

        currentFile = file;

        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('originalPreview').src = e.target.result;
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('processingSection').classList.remove('hidden');

            // Reset result view
            document.getElementById('resultPreview').classList.add('hidden');
            document.getElementById('resultPlaceholder').classList.remove('hidden');
            document.getElementById('downloadBtn').classList.add('hidden');
        };
        reader.readAsDataURL(file);
    }

    async function processPhoto() {
        if (!currentFile) return;

        const processBtn = document.getElementById('processBtn');
        const processingStatus = document.getElementById('processingStatus');
        const deoldifyOption = document.getElementById('deoldifyOption').checked;
        const aiRestorationOption = document.getElementById('aiRestorationOption').checked;
        const enhanceOption = document.getElementById('enhanceOption').checked;
        const noiseReductionOption = document.getElementById('noiseReductionOption').checked;

        processBtn.disabled = true;
        processingStatus.classList.add('active');

        const formData = new FormData();
        formData.append('file', currentFile);
        formData.append('deoldify', deoldifyOption);
        formData.append('ai_restoration', aiRestorationOption);
        formData.append('enhance', enhanceOption);
        formData.append('noise_reduction', noiseReductionOption);

        try {
            const response = await fetch('/fine-tune', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`Processing failed: ${response.statusText}`);
            }

            const data = await response.json();

            if (data.error) {
                showProcessError(data.error);
                return;
            }

            // Show mask preview if available
            const maskPanel = document.getElementById('maskPanel');
            const previewContainer = document.getElementById('previewContainer');
            if (data.mask_url) {
                document.getElementById('maskPreview').src = data.mask_url;
                document.getElementById('maskPreview').classList.remove('hidden');
                document.getElementById('maskPlaceholder').classList.add('hidden');
                maskPanel.classList.remove('hidden');
                previewContainer.classList.remove('two-col');
            } else {
                maskPanel.classList.add('hidden');
                previewContainer.classList.add('two-col');
            }

            // Show result
            resultFilename = data.result_filename;
            document.getElementById('resultPreview').src = data.result_url;
            document.getElementById('resultPreview').classList.remove('hidden');
            document.getElementById('resultPlaceholder').classList.add('hidden');
            document.getElementById('downloadBtn').classList.remove('hidden');

        } catch (error) {
            showProcessError(`Error: ${error.message}`);
        } finally {
            processBtn.disabled = false;
            processingStatus.classList.remove('active');
        }
    }

    function resetUpload() {
        currentFile = null;
        resultFilename = null;
        document.getElementById('processingSection').classList.add('hidden');
        document.getElementById('uploadSection').classList.remove('hidden');
        fileInput.value = '';
        // Reset mask panel
        document.getElementById('maskPanel').classList.add('hidden');
        document.getElementById('maskPreview').classList.add('hidden');
        document.getElementById('maskPlaceholder').classList.remove('hidden');
        document.getElementById('previewContainer').classList.add('two-col');
    }

    function downloadResult() {
        if (!resultFilename) return;

        const a = document.createElement('a');
        a.href = `/download/${resultFilename}`;
        a.download = resultFilename;
        a.click();
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => errorDiv.style.display = 'none', 5000);
    }

    function showProcessError(message) {
        const errorDiv = document.getElementById('processError');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => errorDiv.style.display = 'none', 5000);
    }
</script>
{% endblock %}
