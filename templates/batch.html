{% extends "base.html" %}

{% block page_title %}Batch Enhancement{% endblock %}
{% block page_subtitle %}Enhance multiple photos at once with AI-powered processing{% endblock %}

{% block extra_styles %}
<style>
    .upload-area {
        border: 3px dashed #667eea;
        border-radius: 8px;
        padding: 50px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9ff;
    }

    .upload-area:hover {
        border-color: #764ba2;
        background: #f0f2ff;
    }

    .upload-area.drag-over {
        border-color: #764ba2;
        background: #e8ebff;
        transform: scale(1.02);
    }

    .upload-icon {
        font-size: 3.5rem;
        margin-bottom: 15px;
    }

    .upload-text {
        font-size: 1.1rem;
        color: #333;
        margin-bottom: 8px;
    }

    .upload-hint {
        color: #666;
        font-size: 0.85rem;
    }

    input[type="file"] {
        display: none;
    }

    /* Preview Section */
    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .preview-title {
        font-size: 1.3rem;
        color: #333;
    }

    .preview-actions {
        display: flex;
        gap: 10px;
    }

    .select-all-btn, .deselect-all-btn {
        padding: 8px 16px;
        background: #f0f0f0;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .select-all-btn:hover, .deselect-all-btn:hover {
        background: #e0e0e0;
    }

    .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
        max-height: 500px;
        overflow-y: auto;
        padding: 10px;
    }

    .preview-item {
        position: relative;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .preview-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .preview-item.selected {
        border-color: #667eea;
        box-shadow: 0 0 0 2px #667eea;
    }

    .preview-item img {
        width: 100%;
        height: 180px;
        object-fit: cover;
        display: block;
    }

    .preview-checkbox {
        position: absolute;
        top: 10px;
        left: 10px;
        width: 24px;
        height: 24px;
        cursor: pointer;
        z-index: 10;
    }

    .preview-filename {
        padding: 8px;
        background: #f8f8f8;
        font-size: 0.8rem;
        color: #666;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .enhance-controls {
        text-align: center;
        padding: 20px;
        background: #f8f9ff;
        border-radius: 8px;
    }

    .selected-count {
        margin-bottom: 15px;
        font-size: 1rem;
        color: #667eea;
        font-weight: 500;
    }

    /* Gallery Section */
    .gallery-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .gallery-title {
        font-size: 1.5rem;
        color: #333;
    }

    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .gallery-card {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .gallery-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .gallery-card img {
        width: 100%;
        height: 220px;
        object-fit: cover;
    }

    .gallery-info {
        padding: 12px;
        text-align: center;
    }

    .gallery-filename {
        font-weight: 500;
        color: #333;
        margin-bottom: 4px;
    }

    .gallery-hint {
        font-size: 0.8rem;
        color: #999;
    }

    /* Detail View */
    .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .image-navigation {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .nav-btn {
        padding: 8px 16px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .nav-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .image-counter {
        margin: 0 10px;
        font-weight: 500;
        color: #667eea;
    }

    .comparison-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
    }

    .image-panel {
        text-align: center;
    }

    .image-panel h3 {
        margin-bottom: 12px;
        color: #667eea;
        font-size: 1.1rem;
    }

    .image-panel canvas,
    .image-panel img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .sliders-container {
        background: #f8f9ff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .slider-group {
        margin-bottom: 15px;
    }

    .slider-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
        font-weight: 500;
        color: #333;
        font-size: 0.95rem;
    }

    .slider {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #ddd;
        outline: none;
        -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
    }

    .slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
        border: none;
    }

    .detail-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
    }

    /* Progress Bar */
    .progress-container {
        display: none;
        margin-top: 15px;
        background: #f0f0f0;
        border-radius: 8px;
        overflow: hidden;
    }

    .progress-bar {
        height: 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- Upload Section -->
<div class="card" id="uploadSection">
    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÅ</div>
        <div class="upload-text">Click to select photos or drag & drop here</div>
        <div class="upload-hint">Support: JPG, PNG, GIF, BMP | Batch upload available</div>
    </div>
    <input type="file" id="fileInput" multiple accept="image/*">
    <div class="error-message" id="errorMessage"></div>
</div>

<!-- Preview Section -->
<div class="card hidden" id="previewSection">
    <div class="preview-header">
        <h2 class="preview-title">Select Photos to Enhance</h2>
        <div class="preview-actions">
            <button class="select-all-btn" onclick="selectAll()">Select All</button>
            <button class="deselect-all-btn" onclick="deselectAll()">Deselect All</button>
        </div>
    </div>

    <div class="preview-grid" id="previewGrid"></div>

    <div class="enhance-controls">
        <div class="selected-count" id="selectedCount">0 photos selected</div>
        <button class="btn" id="enhanceBtn" onclick="enhanceSelected()" disabled>Enhance Selected</button>
        <button class="btn btn-secondary" onclick="resetUpload()">Cancel</button>
    </div>

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar">0%</div>
    </div>
</div>

<!-- Gallery Section -->
<div class="card hidden" id="gallerySection">
    <div class="gallery-header">
        <h2 class="gallery-title">Enhanced Photos</h2>
        <div>
            <button class="btn" onclick="downloadAll()">Download All</button>
            <button class="btn btn-secondary" onclick="confirmReset()">Reset</button>
        </div>
    </div>
    <div class="gallery-grid" id="galleryGrid"></div>
</div>

<!-- Detail Section -->
<div class="card hidden" id="detailSection">
    <div class="detail-header">
        <button class="btn btn-secondary" onclick="backToGallery()">‚Üê Back to Gallery</button>
        <div class="image-navigation" id="imageNavigation">
            <button class="nav-btn" id="prevImageBtn" onclick="navigateImage(-1)">‚Üê Previous</button>
            <span class="image-counter" id="imageCounter"></span>
            <button class="nav-btn" id="nextImageBtn" onclick="navigateImage(1)">Next ‚Üí</button>
        </div>
        <button class="btn" onclick="downloadCurrent()">Download</button>
    </div>

    <div class="comparison-container">
        <div class="image-panel">
            <h3>Original</h3>
            <img id="originalImage" src="" alt="Original">
        </div>
        <div class="image-panel">
            <h3>Enhanced (Live Adjustments)</h3>
            <canvas id="enhancedCanvas"></canvas>
        </div>
    </div>

    <div class="sliders-container">
        <div class="slider-group">
            <div class="slider-label">
                <span>Contrast</span>
                <span id="contrastValue">50</span>
            </div>
            <input type="range" min="0" max="100" value="50" class="slider" id="contrastSlider">
        </div>

        <div class="slider-group">
            <div class="slider-label">
                <span>Noise Reduction</span>
                <span id="denoiseValue">50</span>
            </div>
            <input type="range" min="0" max="100" value="50" class="slider" id="denoiseSlider">
        </div>

        <div class="slider-group">
            <div class="slider-label">
                <span>Sharpness</span>
                <span id="sharpenValue">50</span>
            </div>
            <input type="range" min="0" max="100" value="50" class="slider" id="sharpenSlider">
        </div>

        <div class="slider-group">
            <div class="slider-label">
                <span>Color Saturation</span>
                <span id="saturationValue">50</span>
            </div>
            <input type="range" min="0" max="100" value="50" class="slider" id="saturationSlider">
        </div>

        <div class="slider-group">
            <div class="slider-label">
                <span>Brightness</span>
                <span id="brightnessValue">50</span>
            </div>
            <input type="range" min="0" max="100" value="50" class="slider" id="brightnessSlider">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedFiles = new Map();
    let processedResults = [];
    let currentImageIndex = 0;
    let imageSettings = {};
    let imageProcessors = {};

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });

    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
    });

    function handleFiles(files) {
        const imageFiles = files.filter(f => f.type.startsWith('image/'));

        if (imageFiles.length === 0) {
            showError('No valid image files selected');
            return;
        }

        document.getElementById('uploadSection').classList.add('hidden');
        document.getElementById('previewSection').classList.remove('hidden');

        const previewGrid = document.getElementById('previewGrid');
        previewGrid.innerHTML = '';
        selectedFiles.clear();

        imageFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item selected';
                previewItem.innerHTML = `
                    <input type="checkbox" class="preview-checkbox" checked data-filename="${file.name}">
                    <img src="${e.target.result}" alt="${file.name}">
                    <div class="preview-filename">${file.name}</div>
                `;

                const checkbox = previewItem.querySelector('.preview-checkbox');
                checkbox.addEventListener('change', updateSelection);

                previewItem.addEventListener('click', (event) => {
                    if (event.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        updateSelection.call(checkbox);
                    }
                });

                previewGrid.appendChild(previewItem);
                selectedFiles.set(file.name, file);
            };
            reader.readAsDataURL(file);
        });

        updateSelectedCount();
    }

    function updateSelection() {
        const filename = this.dataset.filename;
        const previewItem = this.closest('.preview-item');

        if (this.checked) {
            previewItem.classList.add('selected');
            const allFiles = Array.from(fileInput.files);
            const file = allFiles.find(f => f.name === filename);
            if (file) selectedFiles.set(filename, file);
        } else {
            previewItem.classList.remove('selected');
            selectedFiles.delete(filename);
        }

        updateSelectedCount();
    }

    function updateSelectedCount() {
        const count = selectedFiles.size;
        document.getElementById('selectedCount').textContent = `${count} photo${count !== 1 ? 's' : ''} selected`;
        document.getElementById('enhanceBtn').disabled = count === 0;
    }

    function selectAll() {
        document.querySelectorAll('.preview-checkbox').forEach(cb => {
            cb.checked = true;
            updateSelection.call(cb);
        });
    }

    function deselectAll() {
        document.querySelectorAll('.preview-checkbox').forEach(cb => {
            cb.checked = false;
            updateSelection.call(cb);
        });
    }

    async function enhanceSelected() {
        if (selectedFiles.size === 0) return;

        const enhanceBtn = document.getElementById('enhanceBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        enhanceBtn.disabled = true;
        progressContainer.style.display = 'block';

        const formData = new FormData();
        selectedFiles.forEach(file => formData.append('files', file));

        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`Upload failed: ${response.statusText}`);
            }

            const data = await response.json();

            if (data.error) {
                showError(data.error);
                return;
            }

            processedResults = data.results;
            showGallery();

        } catch (error) {
            showError(`Error: ${error.message}`);
        } finally {
            enhanceBtn.disabled = false;
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
        }
    }

    function showGallery() {
        document.getElementById('previewSection').classList.add('hidden');
        document.getElementById('gallerySection').classList.remove('hidden');

        const galleryGrid = document.getElementById('galleryGrid');
        galleryGrid.innerHTML = '';

        processedResults.forEach((result, index) => {
            const card = document.createElement('div');
            card.className = 'gallery-card';
            card.innerHTML = `
                <img src="${result.enhanced}" alt="${result.filename}">
                <div class="gallery-info">
                    <div class="gallery-filename">${result.filename}</div>
                    <div class="gallery-hint">Click to adjust</div>
                </div>
            `;
            card.onclick = () => showImageDetail(index);
            galleryGrid.appendChild(card);
        });
    }

    function showImageDetail(index) {
        currentImageIndex = index;
        const result = processedResults[index];

        document.getElementById('gallerySection').classList.add('hidden');
        document.getElementById('detailSection').classList.remove('hidden');

        if (processedResults.length > 1) {
            document.getElementById('imageNavigation').style.display = 'flex';
            document.getElementById('imageCounter').textContent = `Image ${index + 1} of ${processedResults.length}`;
            document.getElementById('prevImageBtn').disabled = index === 0;
            document.getElementById('nextImageBtn').disabled = index === processedResults.length - 1;
        } else {
            document.getElementById('imageNavigation').style.display = 'none';
        }

        const originalImg = document.getElementById('originalImage');
        const canvas = document.getElementById('enhancedCanvas');

        originalImg.src = result.original;

        const enhancedImg = new Image();
        enhancedImg.onload = () => {
            const processor = new ImageProcessor(canvas, enhancedImg);
            imageProcessors[result.filename] = processor;

            const settings = imageSettings[result.filename] || {
                contrast: 50, denoise: 50, sharpen: 50, saturation: 50, brightness: 50
            };

            updateSliders(settings);
            processor.applyAdjustments(
                settings.contrast, settings.denoise, settings.sharpen,
                settings.saturation, settings.brightness
            );
        };
        enhancedImg.src = result.enhanced;
    }

    function updateSliders(settings) {
        document.getElementById('contrastSlider').value = settings.contrast;
        document.getElementById('contrastValue').textContent = settings.contrast;

        document.getElementById('denoiseSlider').value = settings.denoise;
        document.getElementById('denoiseValue').textContent = settings.denoise;

        document.getElementById('sharpenSlider').value = settings.sharpen;
        document.getElementById('sharpenValue').textContent = settings.sharpen;

        document.getElementById('saturationSlider').value = settings.saturation;
        document.getElementById('saturationValue').textContent = settings.saturation;

        document.getElementById('brightnessSlider').value = settings.brightness;
        document.getElementById('brightnessValue').textContent = settings.brightness;
    }

    function navigateImage(direction) {
        const newIndex = currentImageIndex + direction;
        if (newIndex >= 0 && newIndex < processedResults.length) {
            showImageDetail(newIndex);
        }
    }

    function backToGallery() {
        document.getElementById('detailSection').classList.add('hidden');
        document.getElementById('gallerySection').classList.remove('hidden');
    }

    function resetUpload() {
        selectedFiles.clear();
        document.getElementById('previewSection').classList.add('hidden');
        document.getElementById('uploadSection').classList.remove('hidden');
        fileInput.value = '';
    }

    function confirmReset() {
        if (confirm('Are you sure you want to reset? All enhanced photos and settings will be lost.')) {
            resetToUpload();
        }
    }

    function resetToUpload() {
        processedResults = [];
        imageSettings = {};
        imageProcessors = {};
        selectedFiles.clear();
        document.getElementById('gallerySection').classList.add('hidden');
        document.getElementById('detailSection').classList.add('hidden');
        document.getElementById('previewSection').classList.add('hidden');
        document.getElementById('uploadSection').classList.remove('hidden');
        fileInput.value = '';
    }

    function downloadCurrent() {
        const result = processedResults[currentImageIndex];
        const canvas = document.getElementById('enhancedCanvas');

        canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `enhanced_${result.filename}`;
            a.click();
            URL.revokeObjectURL(url);
        }, 'image/jpeg', 0.95);
    }

    async function downloadAll() {
        const filenames = processedResults.map(r => r.filename);

        try {
            const response = await fetch('/download-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filenames })
            });

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'enhanced_photos.zip';
            a.click();
            URL.revokeObjectURL(url);
        } catch (error) {
            showError(`Download failed: ${error.message}`);
        }
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => errorDiv.style.display = 'none', 5000);
    }

    const sliders = [
        { id: 'contrastSlider', valueId: 'contrastValue', key: 'contrast' },
        { id: 'denoiseSlider', valueId: 'denoiseValue', key: 'denoise' },
        { id: 'sharpenSlider', valueId: 'sharpenValue', key: 'sharpen' },
        { id: 'saturationSlider', valueId: 'saturationValue', key: 'saturation' },
        { id: 'brightnessSlider', valueId: 'brightnessValue', key: 'brightness' }
    ];

    sliders.forEach(({ id, valueId, key }) => {
        const slider = document.getElementById(id);
        const valueDisplay = document.getElementById(valueId);

        slider.addEventListener('input', () => {
            const value = parseInt(slider.value);
            valueDisplay.textContent = value;

            const result = processedResults[currentImageIndex];
            if (!imageSettings[result.filename]) {
                imageSettings[result.filename] = {};
            }
            imageSettings[result.filename][key] = value;

            const processor = imageProcessors[result.filename];
            if (processor) {
                const settings = imageSettings[result.filename];
                processor.applyAdjustments(
                    settings.contrast || 50,
                    settings.denoise || 50,
                    settings.sharpen || 50,
                    settings.saturation || 50,
                    settings.brightness || 50
                );
            }
        });
    });
</script>
{% endblock %}
